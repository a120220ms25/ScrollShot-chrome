# ✨ 全新文字編輯功能

## 功能概述

文字工具現在支援直接在畫面上輸入和編輯，就像專業的圖片編輯軟體一樣！

### 🎯 新功能

1. **直接在畫面上輸入** - 不再是彈出對話框
2. **拖動移動位置** - 用滑鼠自由移動文字框
3. **調整大小** - 拖動右下角調整文字框大小
4. **多行文字** - 支援 Enter 換行
5. **即時預覽** - 所見即所得

## 使用方法

### 基本操作

1. **添加文字**
   ```
   1. 選擇文字工具（點擊工具列的 T 圖標）
   2. 在截圖上點擊任意位置
   3. 會出現一個可編輯的文字框
   ```

2. **輸入文字**
   ```
   - 直接開始打字
   - 按 Enter 可以換行
   - 預設文字會是當前選擇的顏色和大小
   ```

3. **移動文字框**
   ```
   - 將滑鼠移到文字框的邊框上
   - 按住並拖動
   - 放開滑鼠完成移動
   ```

4. **調整大小**
   ```
   - 找到文字框右下角的小方塊（調整控制點）
   - 按住並拖動
   - 文字框會跟著變大或變小
   ```

5. **確認文字**
   ```
   方法 1: 點擊綠色的 ✓ 按鈕
   方法 2: 文字會被繪製到截圖上
   ```

6. **取消**
   ```
   方法 1: 點擊紅色的 ✕ 按鈕
   方法 2: 按 Esc 鍵
   ```

## 界面元素

### 文字框組成

```
┌─────────────────────────┐
│ 輸入文字...  [可編輯]   │ ← 文字內容區域
│                         │
└─────────────────────────┘
                         ■  ← 調整大小控制點
  [ ✓ ]  [ ✕ ]           ← 確認/取消按鈕
```

### 視覺提示

| 元素 | 外觀 | 說明 |
|------|------|------|
| 文字框邊框 | 虛線邊框 | 使用當前選擇的顏色 |
| 調整控制點 | 小方塊 | 右下角，與文字顏色相同 |
| 確認按鈕 | 綠色 ✓ | 點擊完成編輯 |
| 取消按鈕 | 紅色 ✕ | 點擊放棄編輯 |

## 功能詳解

### 1. 直接在畫面上編輯

**舊版本**：
- 點擊位置後，彈出對話框
- 在對話框中輸入文字
- 無法預覽效果

**新版本**：
- 點擊位置後，直接在畫面上顯示文字框
- 即時看到文字顏色和大小
- 所見即所得

### 2. 拖動移動

**如何使用**：
```
1. 滑鼠移到文字框的邊框或背景上
2. 游標會變成移動圖標（四向箭頭）
3. 按住滑鼠左鍵並拖動
4. 放開滑鼠，文字框停留在新位置
```

**注意**：
- 在文字內容上點擊是選擇文字，不會拖動
- 要拖動，請點擊文字框的邊緣

### 3. 調整大小

**調整控制點位置**：
- 右下角有一個小方塊
- 顏色與當前文字顏色相同
- 游標移上去會變成斜向調整圖標

**如何調整**：
```
1. 滑鼠移到右下角的控制點上
2. 游標會變成斜向箭頭 ↘
3. 按住並拖動
4. 文字框會跟著變大或變小
```

**限制**：
- 最小寬度：100px
- 最小高度：30px
- 確保文字始終可見

### 4. 多行文字支援

**使用方法**：
```
這是第一行 [按 Enter]
這是第二行 [按 Enter]
這是第三行
```

**自動換行**：
- 文字超過框寬會自動換行
- 可以手動調整框寬控制換行

**繪製效果**：
- 每行之間有適當間距（字體大小 × 1.2）
- 保持文字對齊和可讀性

## 技術實現

### 使用的技術

**DOM 元素**：
- `div` 元素作為容器
- `contentEditable` 實現直接編輯
- 動態創建和銷毀

**拖動實現**：
```javascript
mousedown → 記錄起始位置
mousemove → 計算偏移並更新位置
mouseup → 結束拖動
```

**調整大小實現**：
```javascript
mousedown on handle → 記錄起始尺寸
mousemove → 計算新尺寸並更新
mouseup → 結束調整
```

**繪製到 Canvas**：
```javascript
1. 獲取文字框位置和內容
2. 考慮縮放比例進行座標轉換
3. 使用 Canvas fillText 繪製每一行
4. 支援多行文字（自動計算行高）
```

### 與縮放的整合

文字框位置會根據當前的縮放比例（zoomLevel）調整：

```javascript
// 創建時
left: x * zoomLevel + canvasOffset
top: y * zoomLevel + canvasOffset

// 繪製時
actualX = (boxLeft - canvasLeft) / zoomLevel
actualY = (boxTop - canvasTop) / zoomLevel
```

這確保在任何縮放級別下都能正確工作。

## 快捷鍵

| 按鍵 | 功能 |
|------|------|
| `Esc` | 取消編輯，關閉文字框 |
| `Enter` | 換行（在文字框內） |
| 點擊 ✓ | 確認文字 |
| 點擊 ✕ | 取消文字 |

## 與其他功能的整合

### 顏色選擇

文字框會使用當前選擇的顏色：
- 邊框顏色 = 當前顏色
- 文字顏色 = 當前顏色
- 調整控制點 = 當前顏色

**建議**：先選擇顏色，再添加文字

### 字體大小

文字大小由工具列的字體大小選擇器控制：
- 範圍：12px - 32px
- 預設：16px

**建議**：先選擇字體大小，再添加文字

### 撤銷/重做

- 文字確認後會保存到歷史記錄
- 可以使用 Ctrl+Z 撤銷
- 可以使用 Ctrl+Y 重做

**注意**：
- 只有確認後的文字可以撤銷
- 取消的文字不會進入歷史

## 最佳實踐

### 添加文字的建議流程

```
1. 選擇文字工具
2. 選擇想要的顏色（從顏色選擇器）
3. 選擇想要的字體大小（從下拉選單）
4. 點擊截圖上的位置
5. 輸入文字內容
6. 調整位置（拖動）
7. 調整大小（如需要）
8. 點擊 ✓ 確認
```

### 技巧

**精確定位**：
1. 粗略放置文字框
2. 輸入文字
3. 拖動到精確位置
4. 確認

**多行標註**：
1. 創建較寬的文字框（拖動調整）
2. 輸入多行文字
3. 調整寬度控制換行
4. 確認

**快速添加**：
1. 點擊位置
2. 立即輸入文字
3. 不移動直接確認
4. 重複以上步驟

## 範例場景

### 場景 1: 添加標題

```
1. 選擇文字工具
2. 字體大小選擇 28px
3. 顏色選擇深藍色 #2c5282
4. 點擊截圖頂部中央
5. 輸入「系統架構圖」
6. 點擊 ✓
```

### 場景 2: 添加多個標註

```
1. 選擇文字工具
2. 字體大小 16px，顏色紅色
3. 點擊第一個要標註的位置
4. 輸入「步驟 1」，確認
5. 再次點擊第二個位置
6. 輸入「步驟 2」，確認
7. 重複...
```

### 場景 3: 添加說明文字

```
1. 選擇文字工具
2. 點擊位置
3. 拖動右下角，創建較大的文字框
4. 輸入多行說明：
   「這個功能用於...
    主要步驟包括...
    注意事項：...」
5. 調整位置到合適的地方
6. 確認
```

## 故障排除

### 問題：文字框無法拖動

**可能原因**：點擊了文字內容區域

**解決方法**：
- 點擊文字框的邊框或背景
- 不要點擊文字本身

### 問題：無法輸入文字

**可能原因**：文字框失去焦點

**解決方法**：
- 點擊文字框內部重新獲得焦點
- 重新創建文字框

### 問題：文字位置不正確

**可能原因**：縮放後座標計算偏移

**解決方法**：
- 這是已知問題，會在繪製時自動校正
- 確認時會使用正確的座標

### 問題：調整大小控制點看不見

**可能原因**：
- 文字框太小
- 顏色與背景相似

**解決方法**：
- 放大文字框
- 選擇對比度高的顏色

## 更新日誌

### v1.1.0 - 2024-12-15

**新增**：
- ✅ 直接在畫面上編輯文字
- ✅ 拖動移動功能
- ✅ 調整大小功能
- ✅ 多行文字支援
- ✅ 即時視覺反饋
- ✅ 確認/取消按鈕

**改進**：
- 更直覺的用戶體驗
- 所見即所得
- 更靈活的文字定位

**向後兼容**：
- 保留了舊的 confirmText 和 cancelText 函數
- 快捷鍵仍然有效

## 未來改進計劃

### 計畫功能

- [ ] 文字樣式選項（粗體、斜體）
- [ ] 文字對齊方式（左對齊、居中、右對齊）
- [ ] 文字陰影和描邊
- [ ] 背景色選項
- [ ] 自動調整框大小以適應內容
- [ ] 支援表情符號選擇器
- [ ] 文字旋轉功能

---

**盡情使用新的文字編輯功能！** ✨

如有問題或建議，歡迎回饋。
